{% extends "base.html" %}
{% block title %}تفاصيل الطلب رقم {{ req.id }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div>
            <div class="card-title">تفاصيل طلب التجهيز #{{ req.id }}</div>
            <div class="card-subtitle">
                القسم: {{ req.department }} – مقدم الطلب: {{ req.requester_name }}
            </div>
        </div>
        <div>
            {% if "قيد" in req.status %}
                <span class="status-pill status-pending">{{ req.status }}</span>
            {% elif "موافق" in req.status %}
                <span class="status-pill status-approved">{{ req.status }}</span>
            {% elif "مرفوض" in req.status %}
                <span class="status-pill status-rejected">{{ req.status }}</span>
            {% elif "إرجاع" in req.status %}
                <span class="status-pill status-return">{{ req.status }}</span>
            {% else %}
                <span class="status-pill">{{ req.status }}</span>
            {% endif %}
        </div>
    </div>

    <div class="form-grid" style="margin-bottom:18px;">
        <div>
            <label>اسم مقدم الطلب</label>
            <div>{{ req.requester_name }}</div>
        </div>
        <div>
            <label>القسم / الوحدة</label>
            <div>{{ req.department }}</div>
        </div>
        <div>
            <label>البريد الإلكتروني</label>
            <div>{{ req.email }}</div>
        </div>
        <div>
            <label>المسمى الوظيفي</label>
            <div>{{ req.job_title or "-" }}</div>
        </div>
        <div>
            <label>التصنيف</label>
            <div>{{ req.category }}</div>
        </div>
        <div>
            <label>الكمية</label>
            <div>{{ req.quantity }} {{ req.unit }}</div>
        </div>
        <div>
            <label>المبلغ التخميني الكلي</label>
            <div>{{ "{:,.0f}".format(req.estimated_total) }} د.ع</div>
        </div>
        <div>
            <label>صاحب الصلاحية</label>
            <div>{{ req.approver_title }}</div>
        </div>
        <div>
            <label>تاريخ إنشاء الطلب</label>
            <div>{{ req.created_at }}</div>
        </div>
        <div>
            <label>تاريخ القرار</label>
            <div>{{ req.decided_at or "-" }}</div>
        </div>
    </div>

    <div style="margin-bottom:12px;">
        <label>وصف المواد المطلوبة</label>
        <div>{{ req.item_description }}</div>
    </div>
    <div style="margin-bottom:12px;">
        <label>المواصفات الفنية / التجارية</label>
        <div>{{ req.specs or "-" }}</div>
    </div>
    <div style="margin-bottom:18px;">
        <label>مبررات الطلب</label>
        <div>{{ req.justification or "-" }}</div>
    </div>

    <hr style="margin:14px 0;">

    <h4 style="margin-top:0;">إجراء صاحب الصلاحية</h4>
    <p style="font-size:12px;color:#555;">
        آخر إجراء بواسطة: {{ req.approver_name or "-" }}
    </p>

    <form method="post" action="{{ url_for('request_decision', rid=req.id) }}">
        <div style="margin-bottom:10px;">
            <label>ملاحظة القرار</label>
            <textarea name="note" placeholder="سبب الموافقة / الرفض / الإرجاع للاستكمال"></textarea>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button type="submit" name="action" value="approve" class="btn-primary">موافقة</button>
            <button type="submit" name="action" value="reject" class="btn-secondary">رفض</button>
            <button type="submit" name="action" value="return" class="btn-secondary">إرجاع للاستكمال</button>
        </div>
    </form>
</div>
{% endblock %}
